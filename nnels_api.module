<?php

use Drupal\restful\Plugin\FormatterPluginManager;
use Drupal\restful\Plugin\resource\ResourceInterface;
use Drupal\restful\Authentication\AuthenticationManager;

//Unknown registry bug prevents these plugin definitions from discovery on staging/prod but not local.
//Below hook adds them back in.

function nnels_api_formatter_plugin_alter(&$plugins) {

    $plugin_manager = FormatterPluginManager::create();

    $lost_defs = array( 'json_api' => array ( 'id' => 'json_api', 'label' => 'JSON API', 'description' => 'Output in using the JSON API format.', 'class' => 'Drupal\\restful\\Plugin\\formatter\\FormatterJsonApi', 'provider' => 'restful', ), 'hal_json' => array ( 'id' => 'hal_json', 'label' => 'HAL+JSON', 'description' => 'Output in using the HAL conventions and JSON format.', 'curie' => array ( 'name' => 'hal', 'path' => 'doc/rels', 'template' => '/{rel}', ), 'class' => 'Drupal\\restful\\Plugin\\formatter\\FormatterHalJson', 'provider' => 'restful', ), 'single_json' => array ( 'id' => 'single_json', 'label' => 'Single JSON', 'description' => 'Output a single item using the JSON format.', 'class' => 'Drupal\\restful\\Plugin\\formatter\\FormatterSingleJson', 'provider' => 'restful', ), 'json' => array ( 'id' => 'json', 'label' => 'Simple JSON', 'description' => 'Output in using the JSON format.', 'class' => 'Drupal\\restful\\Plugin\\formatter\\FormatterJson', 'provider' => 'restful', ) );

    foreach ($lost_defs as $base_def) {
        $plugin_manager->processDefinition($base_def);
        $plugins[$base_def['id']] = $base_def;
    }
}

/**
 * Implements hook_restful_authentication_plugin_alter()
 * @param $plugins
 */
function nnels_api_authentication_plugin_alter(&$plugins) {

  $lost_defs = array (
    'token' =>
      array (
        'label' => 'Token based authentication',
        'description' => 'Authenticate requests based on the token sent in the request.',
        'settings' => array (),
        'id' => 'token',
        'options' =>
          array (
            'paramName' => 'access_token',
          ),
        'class' => 'Drupal\restful_token_auth\Plugin\authentication\TokenAuthentication',
        'provider' => 'restful_token_auth',
      ),
    'basic_auth' =>
      array (
        'label' => 'Basic authentication',
        'description' => 'Authenticate requests based on basic auth.',
        'settings' =>
          array (
          ),
        'id' => 'basic_auth',
        'class' => 'Drupal\restful\Plugin\authentication\BasicAuthentication',
        'provider' => 'restful',
      )
      );

      $plugins = $plugins + $lost_defs;
}